<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Amazon Buybox Tracker</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;font-size:16px;}
.header{background:linear-gradient(135deg,#1e293b,#0f172a);border-bottom:1px solid #334155;padding:20px 32px;display:flex;justify-content:space-between;align-items:center;}
.header h1{font-size:1.8rem;font-weight:700;color:#f1f5f9;}
.header h1 span{color:#f97316;}
.badge{padding:6px 16px;border-radius:20px;font-size:0.9rem;font-weight:600;}
.badge-online{background:#065f46;color:#6ee7b7;}
.badge-offline{background:#7f1d1d;color:#fca5a5;}
.nav{display:flex;gap:4px;background:#1e293b;padding:4px;border-radius:8px;}
.nav-btn{padding:10px 24px;border:none;background:transparent;color:#94a3b8;cursor:pointer;border-radius:6px;font-size:1rem;font-weight:500;transition:all 0.2s;}
.nav-btn.active{background:#f97316;color:#fff;}
.nav-btn:hover:not(.active){background:#334155;color:#e2e8f0;}
.main{padding:32px;width:100%;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:28px;}
.stat-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:24px;text-align:center;}
.stat-card .val{font-size:2.6rem;font-weight:800;margin:10px 0;}
.stat-card .lbl{font-size:0.95rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.05em;}
.val-win{color:#10b981;}
.val-lose{color:#ef4444;}
.val-amazon{color:#3b82f6;}
.val-total{color:#f97316;}
.val-price{color:#a78bfa;}
.card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:24px;margin-bottom:24px;}
.card h2{font-size:1.2rem;font-weight:600;margin-bottom:18px;color:#f1f5f9;}
.form-row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-end;}
.form-group{display:flex;flex-direction:column;gap:8px;}
.form-group label{font-size:0.95rem;color:#94a3b8;font-weight:500;}
input,select,textarea{background:#0f172a;border:1px solid #334155;color:#e2e8f0;padding:12px 16px;border-radius:8px;font-size:1rem;outline:none;transition:border 0.2s;}
input:focus,select:focus,textarea:focus{border-color:#f97316;}
textarea{resize:vertical;min-height:120px;font-family:monospace;font-size:1rem;}
.btn{padding:12px 24px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.2s;}
.btn-primary{background:#f97316;color:#fff;}
.btn-primary:hover{background:#ea580c;}
.btn-danger{background:#ef4444;color:#fff;}
.btn-danger:hover{background:#dc2626;}
.btn-sm{padding:7px 14px;font-size:0.875rem;}
.btn:disabled{opacity:0.5;cursor:not-allowed;}
.search-bar{display:flex;gap:14px;margin-bottom:18px;flex-wrap:wrap;}
.search-bar input{flex:1;min-width:200px;}
.filter-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;}
.filter-btn{padding:8px 18px;border:1px solid #334155;background:transparent;color:#94a3b8;border-radius:20px;cursor:pointer;font-size:0.95rem;transition:all 0.2s;}
.filter-btn.active{border-color:#f97316;color:#f97316;background:rgba(249,115,22,0.1);}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:0.95rem;}
th{background:#0f172a;padding:13px 16px;text-align:left;color:#94a3b8;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid #334155;white-space:nowrap;}
td{padding:13px 16px;border-bottom:1px solid #1e293b;vertical-align:middle;}
tr:hover td{background:rgba(255,255,255,0.02);}
.status-badge{display:inline-flex;align-items:center;gap:5px;padding:5px 14px;border-radius:12px;font-size:0.875rem;font-weight:600;white-space:nowrap;}
.status-winning{background:rgba(16,185,129,0.15);color:#10b981;border:1px solid rgba(16,185,129,0.3);}
.status-losing{background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);}
.status-amazon{background:rgba(59,130,246,0.15);color:#3b82f6;border:1px solid rgba(59,130,246,0.3);}
.status-unknown{background:rgba(148,163,184,0.15);color:#94a3b8;border:1px solid rgba(148,163,184,0.3);}
.product-img{width:50px;height:50px;object-fit:contain;border-radius:4px;background:#0f172a;}
.no-img{width:40px;height:40px;background:#334155;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;}
.asin-code{font-family:monospace;font-size:0.8rem;color:#94a3b8;}
.price-val{font-weight:700;color:#a78bfa;}
.seller-name{font-weight:600;}
.seller-me{color:#10b981;}
.seller-amazon{color:#3b82f6;}
.seller-other{color:#f97316;}
.page{display:none;}
.page.active{display:block;}
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:20px;}
.chart-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px;}
.chart-card h3{font-size:0.9rem;color:#94a3b8;margin-bottom:16px;}
.bar-chart{display:flex;flex-direction:column;gap:10px;}
.bar-row{display:flex;align-items:center;gap:10px;}
.bar-label{width:120px;font-size:0.8rem;color:#e2e8f0;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bar-track{flex:1;height:24px;background:#0f172a;border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;font-size:0.75rem;font-weight:600;color:#fff;transition:width 0.5s;}
.pie-row{display:flex;align-items:center;justify-content:space-around;flex-wrap:wrap;gap:16px;}
.pie-item{text-align:center;}
.pie-circle{width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:800;margin:0 auto 8px;}
.history-table{font-size:0.8rem;}
.history-table td{padding:7px 10px;}
.change-up{color:#ef4444;}
.change-down{color:#10b981;}
.change-none{color:#94a3b8;}
.loading{display:inline-block;width:16px;height:16px;border:2px solid #334155;border-top-color:#f97316;border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes spin{to{transform:rotate(360deg);}}
.alert{padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:0.875rem;}
.alert-success{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#10b981;}
.alert-error{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;}
.alert-info{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);color:#3b82f6;}
.product-detail{background:#0f172a;border:1px solid #334155;border-radius:8px;padding:16px;margin-top:16px;}
.detail-grid{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:start;}
.detail-img{width:100px;height:100px;object-fit:contain;border-radius:8px;}
.detail-info h3{font-size:1rem;font-weight:600;margin-bottom:8px;}
.detail-row{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;}
.detail-item{text-align:center;background:#1e293b;padding:10px 16px;border-radius:8px;min-width:100px;}
.detail-item .d-val{font-size:1.1rem;font-weight:700;}
.detail-item .d-lbl{font-size:0.7rem;color:#94a3b8;margin-top:2px;}
.progress-bar{height:6px;background:#0f172a;border-radius:3px;margin-top:8px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;background:#f97316;}
.empty-state{text-align:center;padding:60px 20px;color:#475569;}
.empty-state .icon{font-size:3rem;margin-bottom:12px;}
.empty-state p{font-size:0.9rem;}
.bulk-result{margin-top:12px;}
.tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.75rem;margin:2px;background:#334155;color:#94a3b8;}
</style>
</head>
<body>
<div class="header">
  <h1>📦 Amazon <span>Buybox</span> Tracker</h1>
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="nav">
      <button class="nav-btn active" onclick="showPage('dashboard')">🏠 Dashboard</button>
      <button class="nav-btn" onclick="showPage('lookup')">🔍 Lookup</button>
      <button class="nav-btn" onclick="showPage('bulk')">📋 Bulk Upload</button>
      <button class="nav-btn" onclick="showPage('analytics')">📊 Analytics</button>
    </div>
    <span id="backendBadge" class="badge badge-offline">⚫ Offline</span>
  </div>
</div>

<div class="main">

<!-- DASHBOARD PAGE -->
<div id="page-dashboard" class="page active">
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card"><div class="val val-win" id="s-winning">0</div><div class="lbl">🏆 Winning</div></div>
    <div class="stat-card"><div class="val val-lose" id="s-losing">0</div><div class="lbl">😞 Losing</div></div>
    <div class="stat-card"><div class="val val-amazon" id="s-amazon">0</div><div class="lbl">🛒 Amazon Wins</div></div>
    <div class="stat-card"><div class="val val-total" id="s-total">0</div><div class="lbl">📦 Total Tracked</div></div>
    <div class="stat-card"><div class="val val-price" id="s-avgprice">R0</div><div class="lbl">💰 Avg Buybox Price</div></div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h2>📋 Tracked Products</h2>
      <button class="btn btn-primary btn-sm" onclick="refreshAll()">🔄 Refresh All</button>
    </div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="🔍 Search by title, ASIN or seller..." oninput="applyFilters()"/>
    </div>
    <div class="filter-row">
      <span style="font-size:0.8rem;color:#94a3b8;align-self:center;">Filter:</span>
      <button class="filter-btn active" onclick="setFilter('all',this)">All</button>
      <button class="filter-btn" onclick="setFilter('winning',this)">🏆 Winning</button>
      <button class="filter-btn" onclick="setFilter('losing',this)">😞 Losing</button>
      <button class="filter-btn" onclick="setFilter('amazon',this)">🛒 Amazon</button>
    </div>
    <div id="alertBox"></div>
    <div class="table-wrap">
      <table id="productsTable">
        <thead>
          <tr>
            <th></th>
            <th onclick="sortTable('title')" style="cursor:pointer;">Product ↕</th>
            <th onclick="sortTable('asin')" style="cursor:pointer;">ASIN ↕</th>
            <th onclick="sortTable('buybox_price')" style="cursor:pointer;">Buybox Price ↕</th>
            <th onclick="sortTable('buybox_seller')" style="cursor:pointer;">Buybox Seller ↕</th>
            <th>Status</th>
            <th onclick="sortTable('scraped_at')" style="cursor:pointer;">Last Checked ↕</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="productsBody">
          <tr><td colspan="8"><div class="empty-state"><div class="icon">📦</div><p>No products tracked yet.<br>Use Lookup or Bulk Upload to add ASINs.</p></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- LOOKUP PAGE -->
<div id="page-lookup" class="page">
  <div class="card">
    <h2>🔍 Single ASIN Lookup</h2>
    <div class="form-row">
      <div class="form-group">
        <label>ASIN</label>
        <input type="text" id="asinInput" placeholder="e.g. B01ARH3Q5G" style="width:220px;" onkeydown="if(event.key==='Enter')fetchBuybox()"/>
      </div>
      <div class="form-group">
        <label>Marketplace</label>
        <select id="marketSelect">
          <option value="amazon.co.za" selected>🇿🇦 Amazon SA</option>
          <option value="amazon.co.uk">🇬🇧 Amazon UK</option>
          <option value="amazon.com">🇺🇸 Amazon US</option>
          <option value="amazon.de">🇩🇪 Amazon DE</option>
          <option value="amazon.fr">🇫🇷 Amazon FR</option>
          <option value="amazon.ca">🇨🇦 Amazon CA</option>
          <option value="amazon.com.au">🇦🇺 Amazon AU</option>
        </select>
      </div>
      <div class="form-group" style="justify-content:flex-end;">
        <button class="btn btn-primary" id="fetchBtn" onclick="fetchBuybox()">🔍 Fetch Buybox</button>
      </div>
    </div>
    <div id="lookupAlert" style="margin-top:12px;"></div>
    <div id="productDetail"></div>
  </div>
  <div class="card" id="historyCard" style="display:none;">
    <h2>🕐 Price History</h2>
    <div class="table-wrap">
      <table class="history-table">
        <thead><tr><th>Time</th><th>Price</th><th>Seller</th><th>Status</th><th>Change</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- BULK PAGE -->
<div id="page-bulk" class="page">
  <div class="card">
    <h2>📋 Bulk ASIN / URL Upload</h2>
    <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:16px;">Paste one ASIN or Amazon URL per line. Mix of both is supported.</p>
    <div class="form-group" style="margin-bottom:12px;">
      <label>Marketplace</label>
      <select id="bulkMarket" style="width:200px;">
        <option value="amazon.co.za" selected>🇿🇦 Amazon SA</option>
        <option value="amazon.co.uk">🇬🇧 Amazon UK</option>
        <option value="amazon.com">🇺🇸 Amazon US</option>
        <option value="amazon.de">🇩🇪 Amazon DE</option>
        <option value="amazon.fr">🇫🇷 Amazon FR</option>
        <option value="amazon.ca">🇨🇦 Amazon CA</option>
        <option value="amazon.com.au">🇦🇺 Amazon AU</option>
      </select>
    </div>
    <textarea id="bulkInput" placeholder="B01ARH3Q5G&#10;B01ARH7R7Y&#10;https://www.amazon.co.za/dp/B09XYZ1234&#10;..."></textarea>
    <div style="display:flex;gap:12px;margin-top:12px;">
      <button class="btn btn-primary" id="bulkBtn" onclick="submitBulk()">🚀 Fetch All</button>
      <button class="btn btn-sm" style="background:#334155;color:#e2e8f0;" onclick="document.getElementById('bulkInput').value=''">🗑 Clear</button>
    </div>
    <div id="bulkAlert" style="margin-top:12px;"></div>
    <div id="bulkResult" class="bulk-result"></div>
  </div>
</div>

<!-- ANALYTICS PAGE -->
<div id="page-analytics" class="page">
  <div class="analytics-grid">
    <div class="chart-card">
      <h3>🏆 Buybox Distribution</h3>
      <div class="pie-row" id="pieChart">
        <div class="empty-state" style="padding:20px;"><p>No data yet</p></div>
      </div>
    </div>
    <div class="chart-card">
      <h3>💰 Top Prices (Highest Buybox)</h3>
      <div class="bar-chart" id="topPricesChart"></div>
    </div>
    <div class="chart-card">
      <h3>🛒 Sellers Winning Buybox</h3>
      <div class="bar-chart" id="sellersChart"></div>
    </div>
    <div class="chart-card">
      <h3>📈 Win Rate Summary</h3>
      <div id="winRatePanel"></div>
    </div>
  </div>
  <div class="card">
    <h2>📊 All Products Snapshot</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>#</th><th>Product</th><th>ASIN</th><th>Price</th><th>Seller</th><th>Status</th><th>Rating</th><th>Last Checked</th></tr>
        </thead>
        <tbody id="analyticsBody"></tbody>
      </table>
    </div>
  </div>
</div>

</div><!-- end main -->
</body>
<script>
// Auto-detect API URL: use same host when deployed, fallback to localhost for local dev
const API = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
  ? 'http://localhost:8001'
  : window.location.origin;
const MY_SELLER = 'Bonolo Online';
const CURRENCY = {'amazon.co.za':'R','amazon.co.uk':'£','amazon.com':'$','amazon.de':'€','amazon.fr':'€','amazon.ca':'C$','amazon.com.au':'A$'};

let allProducts = [];
let currentFilter = 'all';
let sortCol = 'scraped_at';
let sortDir = -1;

// ── Page Navigation ──────────────────────────────────────────────
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'dashboard') loadDashboard();
  if (name === 'analytics') loadAnalytics();
}

// ── Health Check ─────────────────────────────────────────────────
async function checkHealth() {
  try {
    const r = await fetch(API + '/api/health');
    const d = await r.json();
    const b = document.getElementById('backendBadge');
    b.textContent = '🟢 Backend Online';
    b.className = 'badge badge-online';
  } catch(e) {
    const b = document.getElementById('backendBadge');
    b.textContent = '🔴 Backend Offline';
    b.className = 'badge badge-offline';
  }
}

// ── Format helpers ────────────────────────────────────────────────
function fmtPrice(p, market) {
  if (!p) return '<span style="color:#475569">—</span>';
  const sym = CURRENCY[market] || 'R';
  return `<span class="price-val">${sym}${Number(p).toLocaleString('en-ZA',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>`;
}
function fmtSeller(seller, status) {
  if (!seller || seller === 'Unknown') return '<span style="color:#475569">Unknown</span>';
  const cls = status === 'winning' ? 'seller-me' : status === 'amazon' ? 'seller-amazon' : 'seller-other';
  return `<span class="seller-name ${cls}">${seller}</span>`;
}
function fmtStatus(status, seller) {
  const map = {
    winning: `<span class="status-badge status-winning">🏆 Winning</span>`,
    losing:  `<span class="status-badge status-losing">😞 Losing</span>`,
    amazon:  `<span class="status-badge status-amazon">🛒 Amazon</span>`,
    unknown: `<span class="status-badge status-unknown">❓ Unknown</span>`,
  };
  return map[status] || map.unknown;
}
function fmtTime(iso) {
  if (!iso) return '—';
  const d = new Date(iso);
  return d.toLocaleString('en-ZA');
}
function fmtImg(url) {
  if (!url) return `<div class="no-img">📦</div>`;
  return `<img class="product-img" src="${url}" onerror="this.style.display='none'"/>`;
}
function showAlert(id, msg, type='info') {
  document.getElementById(id).innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
}
function clearAlert(id) { document.getElementById(id).innerHTML = ''; }

// ── Load Dashboard ────────────────────────────────────────────────
async function loadDashboard() {
  try {
    const r = await fetch(API + '/api/buybox/tracked');
    const d = await r.json();
    allProducts = d.asins || [];
    updateStats();
    renderTable();
  } catch(e) {
    showAlert('alertBox', '❌ Cannot connect to backend. Make sure the backend is running on port 8001.', 'error');
  }
}

function updateStats() {
  const winning = allProducts.filter(p => p.buybox_status === 'winning').length;
  const losing  = allProducts.filter(p => p.buybox_status === 'losing').length;
  const amazon  = allProducts.filter(p => p.buybox_status === 'amazon').length;
  const total   = allProducts.length;
  const prices  = allProducts.filter(p => p.buybox_price).map(p => p.buybox_price);
  const avg     = prices.length ? (prices.reduce((a,b)=>a+b,0)/prices.length) : 0;

  document.getElementById('s-winning').textContent = winning;
  document.getElementById('s-losing').textContent  = losing;
  document.getElementById('s-amazon').textContent  = amazon;
  document.getElementById('s-total').textContent   = total;
  document.getElementById('s-avgprice').textContent = `R${avg.toLocaleString('en-ZA',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
}

// ── Filters & Search ──────────────────────────────────────────────
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTable();
}

function applyFilters() { renderTable(); }

function sortTable(col) {
  if (sortCol === col) sortDir *= -1;
  else { sortCol = col; sortDir = -1; }
  renderTable();
}

function renderTable() {
  const search = (document.getElementById('searchInput').value || '').toLowerCase();
  let data = allProducts.filter(p => {
    if (currentFilter !== 'all' && p.buybox_status !== currentFilter) return false;
    if (search) {
      const hay = `${p.title||''} ${p.asin||''} ${p.buybox_seller||''}`.toLowerCase();
      if (!hay.includes(search)) return false;
    }
    return true;
  });

  data.sort((a, b) => {
    let va = a[sortCol] || '';
    let vb = b[sortCol] || '';
    if (typeof va === 'number') return (va - vb) * sortDir;
    return String(va).localeCompare(String(vb)) * sortDir;
  });

  const tbody = document.getElementById('productsBody');
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="icon">🔍</div><p>No products match your search/filter.</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(p => `
    <tr>
      <td>${fmtImg(p.image_url)}</td>
      <td style="max-width:260px;">
        <div style="font-weight:500;font-size:0.85rem;line-height:1.4;">${p.title || '—'}</div>
        <a href="${p.url}" target="_blank" style="font-size:0.75rem;color:#f97316;">View on Amazon ↗</a>
      </td>
      <td><span class="asin-code">${p.asin}</span></td>
      <td>${fmtPrice(p.buybox_price, p.marketplace)}</td>
      <td>${fmtSeller(p.buybox_seller, p.buybox_status)}</td>
      <td>${fmtStatus(p.buybox_status)}</td>
      <td style="font-size:0.8rem;color:#94a3b8;">${fmtTime(p.scraped_at)}</td>
      <td>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-primary btn-sm" onclick="quickRefresh('${p.asin}','${p.marketplace}')">🔄</button>
          <button class="btn btn-sm" style="background:#334155;color:#e2e8f0;" onclick="viewHistory('${p.asin}')">📈</button>
          <button class="btn btn-danger btn-sm" onclick="removeASIN('${p.asin}')">🗑</button>
        </div>
      </td>
    </tr>
  `).join('');
}

async function quickRefresh(asin, market) {
  showAlert('alertBox', `<span class="loading"></span>Refreshing ${asin}...`, 'info');
  try {
    const r = await fetch(API + '/api/buybox/lookup', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({asin,marketplace:market})});
    const d = await r.json();
    const idx = allProducts.findIndex(p => p.asin === asin);
    if (idx >= 0) allProducts[idx] = d;
    updateStats(); renderTable();
    showAlert('alertBox', `✅ ${asin} refreshed — Seller: ${d.buybox_seller || 'Unknown'}, Price: ${d.buybox_price || 'N/A'}`, 'success');
  } catch(e) { showAlert('alertBox', '❌ Refresh failed', 'error'); }
}

async function removeASIN(asin) {
  if (!confirm(`Remove ${asin} from tracking?`)) return;
  await fetch(API + '/api/buybox/tracked/' + asin, {method:'DELETE'});
  allProducts = allProducts.filter(p => p.asin !== asin);
  updateStats(); renderTable();
}

async function refreshAll() {
  showAlert('alertBox', `<span class="loading"></span>Refreshing all ${allProducts.length} products...`, 'info');
  for (const p of allProducts) {
    try {
      const r = await fetch(API + '/api/buybox/lookup', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({asin:p.asin,marketplace:p.marketplace})});
      const d = await r.json();
      const idx = allProducts.findIndex(x => x.asin === p.asin);
      if (idx >= 0) allProducts[idx] = d;
    } catch(e) {}
  }
  updateStats(); renderTable();
  showAlert('alertBox', `✅ All products refreshed!`, 'success');
}

// ── Single Lookup ─────────────────────────────────────────────────
async function fetchBuybox() {
  const asin = document.getElementById('asinInput').value.trim().toUpperCase();
  const market = document.getElementById('marketSelect').value;
  if (!asin) { showAlert('lookupAlert','⚠️ Please enter an ASIN','error'); return; }

  const btn = document.getElementById('fetchBtn');
  btn.disabled = true; btn.innerHTML = '<span class="loading"></span>Fetching...';
  showAlert('lookupAlert', `<span class="loading"></span>Fetching buybox data for <b>${asin}</b>...`, 'info');
  document.getElementById('productDetail').innerHTML = '';
  document.getElementById('historyCard').style.display = 'none';

  try {
    const r = await fetch(API + '/api/buybox/lookup', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({asin,marketplace:market})});
    const d = await r.json();

    if (d.status === 'error' || d.status === 'blocked') {
      showAlert('lookupAlert', `❌ ${d.error || 'Failed to fetch'}`, 'error');
    } else {
      clearAlert('lookupAlert');
      renderProductDetail(d);
      fetchHistory(asin);
      // Update in allProducts
      const idx = allProducts.findIndex(p => p.asin === asin);
      if (idx >= 0) allProducts[idx] = d; else allProducts.push(d);
    }
  } catch(e) {
    showAlert('lookupAlert', '❌ Cannot connect to backend', 'error');
  }
  btn.disabled = false; btn.innerHTML = '🔍 Fetch Buybox';
}

function renderProductDetail(d) {
  const sym = CURRENCY[d.marketplace] || 'R';
  const statusClass = {winning:'status-winning',losing:'status-losing',amazon:'status-amazon',unknown:'status-unknown'}[d.buybox_status] || 'status-unknown';
  const statusLabel = {winning:'🏆 WINNING - Buybox is yours!',losing:'😞 LOSING - Someone else has buybox',amazon:'🛒 AMAZON - Amazon holds the buybox',unknown:'❓ Unknown'}[d.buybox_status] || '❓ Unknown';
  const sellerClass = d.buybox_status==='winning'?'seller-me':d.buybox_status==='amazon'?'seller-amazon':'seller-other';

  document.getElementById('productDetail').innerHTML = `
    <div class="product-detail">
      <div class="detail-grid">
        ${d.image_url ? `<img class="detail-img" src="${d.image_url}"/>` : `<div style="font-size:3rem;">📦</div>`}
        <div>
          <h3>${d.title || 'Unknown Product'}</h3>
          <div style="margin:6px 0;"><span class="asin-code">${d.asin}</span> · <a href="${d.url}" target="_blank" style="color:#f97316;font-size:0.8rem;">View on Amazon ↗</a></div>
          <div><span class="status-badge ${statusClass}">${statusLabel}</span></div>
          <div class="detail-row">
            <div class="detail-item">
              <div class="d-val" style="color:#a78bfa;">${d.buybox_price ? sym+Number(d.buybox_price).toLocaleString('en-ZA',{minimumFractionDigits:2}) : '—'}</div>
              <div class="d-lbl">Buybox Price</div>
            </div>
            <div class="detail-item">
              <div class="d-val ${sellerClass}">${d.buybox_seller || 'Unknown'}</div>
              <div class="d-lbl">Buybox Seller</div>
            </div>
            <div class="detail-item">
              <div class="d-val" style="color:#fbbf24;">${d.rating ? '⭐ '+d.rating : '—'}</div>
              <div class="d-lbl">${d.review_count ? d.review_count+' reviews' : 'Rating'}</div>
            </div>
            <div class="detail-item">
              <div class="d-val" style="color:#94a3b8;font-size:0.85rem;">${d.availability || '—'}</div>
              <div class="d-lbl">Availability</div>
            </div>
          </div>
        </div>
      </div>
    </div>`;
}

async function fetchHistory(asin) {
  try {
    const r = await fetch(API + '/api/buybox/history/' + asin);
    const d = await r.json();
    const history = d.history || [];
    if (!history.length) return;
    document.getElementById('historyCard').style.display = 'block';
    const rows = [...history].reverse().map((h, i, arr) => {
      const prev = arr[i+1];
      let change = '<span class="change-none">—</span>';
      if (prev && prev.price && h.price) {
        const diff = h.price - prev.price;
        if (diff > 0) change = `<span class="change-up">▲ R${diff.toFixed(2)}</span>`;
        else if (diff < 0) change = `<span class="change-down">▼ R${Math.abs(diff).toFixed(2)}</span>`;
        else change = `<span class="change-none">No change</span>`;
      }
      const statusBadge = fmtStatus(h.status);
      return `<tr><td>${fmtTime(h.timestamp)}</td><td class="price-val">R${Number(h.price).toLocaleString('en-ZA',{minimumFractionDigits:2})}</td><td>${fmtSeller(h.seller,h.status)}</td><td>${statusBadge}</td><td>${change}</td></tr>`;
    });
    document.getElementById('historyBody').innerHTML = rows.join('');
  } catch(e) {}
}

async function viewHistory(asin) {
  showPage('lookup');
  document.querySelectorAll('.nav-btn')[1].classList.add('active');
  document.querySelectorAll('.nav-btn')[0].classList.remove('active');
  document.getElementById('asinInput').value = asin;
  fetchHistory(asin);
}

// ── Bulk Upload ───────────────────────────────────────────────────
async function submitBulk() {
  const raw = document.getElementById('bulkInput').value.trim();
  const market = document.getElementById('bulkMarket').value;
  if (!raw) { showAlert('bulkAlert','⚠️ Please enter at least one ASIN or URL','error'); return; }

  const lines = raw.split('\n').map(l => l.trim()).filter(l => l);
  const btn = document.getElementById('bulkBtn');
  btn.disabled = true; btn.innerHTML = '<span class="loading"></span>Processing...';
  showAlert('bulkAlert', `<span class="loading"></span>Fetching ${lines.length} ASINs/URLs... This may take a while.`, 'info');
  document.getElementById('bulkResult').innerHTML = '';

  try {
    const r = await fetch(API + '/api/buybox/bulk-urls', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({urls:lines,marketplace:market})});
    const d = await r.json();
    const results = d.results || [];

    // Add to allProducts
    results.forEach(p => {
      const idx = allProducts.findIndex(x => x.asin === p.asin);
      if (idx >= 0) allProducts[idx] = p; else allProducts.push(p);
    });

    const winning = results.filter(p=>p.buybox_status==='winning').length;
    const losing  = results.filter(p=>p.buybox_status==='losing').length;
    const amazon  = results.filter(p=>p.buybox_status==='amazon').length;

    showAlert('bulkAlert', `✅ Fetched ${results.length} products — 🏆 ${winning} winning, 😞 ${losing} losing, 🛒 ${amazon} Amazon`, 'success');

    document.getElementById('bulkResult').innerHTML = `
      <table style="width:100%;font-size:0.82rem;border-collapse:collapse;margin-top:8px;">
        <thead><tr style="background:#0f172a;">
          <th style="padding:8px;text-align:left;color:#94a3b8;">ASIN</th>
          <th style="padding:8px;text-align:left;color:#94a3b8;">Product</th>
          <th style="padding:8px;text-align:left;color:#94a3b8;">Price</th>
          <th style="padding:8px;text-align:left;color:#94a3b8;">Seller</th>
          <th style="padding:8px;text-align:left;color:#94a3b8;">Status</th>
        </tr></thead>
        <tbody>${results.map(p=>`
          <tr style="border-bottom:1px solid #1e293b;">
            <td style="padding:8px;font-family:monospace;color:#94a3b8;">${p.asin}</td>
            <td style="padding:8px;max-width:200px;">${p.title||'—'}</td>
            <td style="padding:8px;">${fmtPrice(p.buybox_price,p.marketplace)}</td>
            <td style="padding:8px;">${fmtSeller(p.buybox_seller,p.buybox_status)}</td>
            <td style="padding:8px;">${fmtStatus(p.buybox_status)}</td>
          </tr>`).join('')}
        </tbody>
      </table>`;
  } catch(e) {
    showAlert('bulkAlert', '❌ Bulk fetch failed: ' + e.message, 'error');
  }
  btn.disabled = false; btn.innerHTML = '🚀 Fetch All';
}

// ── Analytics ─────────────────────────────────────────────────────
function loadAnalytics() {
  const data = allProducts;
  if (!data.length) return;

  const winning = data.filter(p=>p.buybox_status==='winning').length;
  const losing  = data.filter(p=>p.buybox_status==='losing').length;
  const amazon  = data.filter(p=>p.buybox_status==='amazon').length;
  const total   = data.length;

  // Pie chart
  document.getElementById('pieChart').innerHTML = `
    <div class="pie-item"><div class="pie-circle" style="background:rgba(16,185,129,0.2);color:#10b981;">${winning}</div><div style="font-size:0.8rem;">🏆 Winning</div></div>
    <div class="pie-item"><div class="pie-circle" style="background:rgba(239,68,68,0.2);color:#ef4444;">${losing}</div><div style="font-size:0.8rem;">😞 Losing</div></div>
    <div class="pie-item"><div class="pie-circle" style="background:rgba(59,130,246,0.2);color:#3b82f6;">${amazon}</div><div style="font-size:0.8rem;">🛒 Amazon</div></div>
    <div class="pie-item"><div class="pie-circle" style="background:rgba(249,115,22,0.2);color:#f97316;">${total}</div><div style="font-size:0.8rem;">📦 Total</div></div>`;

  // Top prices bar chart
  const topPrices = [...data].filter(p=>p.buybox_price).sort((a,b)=>b.buybox_price-a.buybox_price).slice(0,8);
  const maxPrice = topPrices[0]?.buybox_price || 1;
  document.getElementById('topPricesChart').innerHTML = topPrices.map(p=>`
    <div class="bar-row">
      <div class="bar-label" title="${p.title}">${p.asin}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(p.buybox_price/maxPrice*100).toFixed(0)}%;background:#a78bfa;">R${Number(p.buybox_price).toLocaleString('en-ZA',{minimumFractionDigits:2})}</div></div>
    </div>`).join('') || '<p style="color:#475569;font-size:0.85rem;">No price data</p>';

  // Sellers bar chart
  const sellerCount = {};
  data.forEach(p => { if (p.buybox_seller) sellerCount[p.buybox_seller] = (sellerCount[p.buybox_seller]||0)+1; });
  const sellers = Object.entries(sellerCount).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const maxSeller = sellers[0]?.[1] || 1;
  document.getElementById('sellersChart').innerHTML = sellers.map(([name,count])=>{
    const isMe = name.toLowerCase().includes('bonolo');
    const isAm = name.toLowerCase().includes('amazon');
    const color = isMe?'#10b981':isAm?'#3b82f6':'#f97316';
    return `<div class="bar-row">
      <div class="bar-label" title="${name}">${name}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(count/maxSeller*100).toFixed(0)}%;background:${color};">${count}</div></div>
    </div>`;
  }).join('') || '<p style="color:#475569;font-size:0.85rem;">No seller data</p>';

  // Win rate
  const winRate = total ? ((winning/total)*100).toFixed(1) : 0;
  document.getElementById('winRatePanel').innerHTML = `
    <div style="text-align:center;padding:16px;">
      <div style="font-size:3rem;font-weight:800;color:${winRate>=50?'#10b981':'#ef4444'};">${winRate}%</div>
      <div style="color:#94a3b8;font-size:0.85rem;margin:8px 0;">Buybox Win Rate</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${winRate}%;background:${winRate>=50?'#10b981':'#ef4444'};"></div></div>
      <div style="margin-top:16px;font-size:0.85rem;color:#94a3b8;">
        ${winning} of ${total} products have buybox
      </div>
    </div>`;

  // Analytics snapshot table
  document.getElementById('analyticsBody').innerHTML = data.map((p,i)=>`
    <tr>
      <td style="color:#475569;font-size:0.8rem;">${i+1}</td>
      <td style="max-width:240px;font-size:0.82rem;">${p.title||'—'}</td>
      <td><span class="asin-code">${p.asin}</span></td>
      <td>${fmtPrice(p.buybox_price,p.marketplace)}</td>
      <td>${fmtSeller(p.buybox_seller,p.buybox_status)}</td>
      <td>${fmtStatus(p.buybox_status)}</td>
      <td style="color:#fbbf24;">${p.rating?'⭐ '+p.rating:'—'}</td>
      <td style="font-size:0.78rem;color:#94a3b8;">${fmtTime(p.scraped_at)}</td>
    </tr>`).join('');
}

// ── Init ──────────────────────────────────────────────────────────
checkHealth();
setInterval(checkHealth, 30000);
loadDashboard();
</script>
</html>
