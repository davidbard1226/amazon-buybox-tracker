<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Amazon Buybox Tracker</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;font-size:16px;}
.header{background:linear-gradient(135deg,#1e293b,#0f172a);border-bottom:1px solid #334155;padding:20px 32px;display:flex;justify-content:space-between;align-items:center;}
.header h1{font-size:1.8rem;font-weight:700;color:#f1f5f9;}
.header h1 span{color:#f97316;}
.badge{padding:6px 16px;border-radius:20px;font-size:0.9rem;font-weight:600;}
.badge-online{background:#065f46;color:#6ee7b7;}
.badge-offline{background:#7f1d1d;color:#fca5a5;}
.nav{display:flex;gap:4px;background:#1e293b;padding:4px;border-radius:8px;}
.nav-btn{padding:10px 24px;border:none;background:transparent;color:#94a3b8;cursor:pointer;border-radius:6px;font-size:1rem;font-weight:500;transition:all 0.2s;}
.nav-btn.active{background:#f97316;color:#fff;}
.nav-btn:hover:not(.active){background:#334155;color:#e2e8f0;}
.main{padding:32px;width:100%;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:28px;}
.stat-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:24px;text-align:center;}
.stat-card .val{font-size:2.6rem;font-weight:800;margin:10px 0;}
.stat-card .lbl{font-size:0.95rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.05em;}
.val-win{color:#10b981;}
.val-lose{color:#ef4444;}
.val-amazon{color:#3b82f6;}
.val-total{color:#f97316;}
.val-price{color:#a78bfa;}
.card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:24px;margin-bottom:24px;}
.card h2{font-size:1.2rem;font-weight:600;margin-bottom:18px;color:#f1f5f9;}
.form-row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-end;}
.form-group{display:flex;flex-direction:column;gap:8px;}
.form-group label{font-size:0.95rem;color:#94a3b8;font-weight:500;}
input,select,textarea{background:#0f172a;border:1px solid #334155;color:#e2e8f0;padding:12px 16px;border-radius:8px;font-size:1rem;outline:none;transition:border 0.2s;}
input:focus,select:focus,textarea:focus{border-color:#f97316;}
textarea{resize:vertical;min-height:120px;font-family:monospace;font-size:1rem;}
.btn{padding:12px 24px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.2s;}
.btn-primary{background:#f97316;color:#fff;}
.btn-primary:hover{background:#ea580c;}
.btn-danger{background:#ef4444;color:#fff;}
.btn-danger:hover{background:#dc2626;}
.btn-sm{padding:7px 14px;font-size:0.875rem;}
.btn:disabled{opacity:0.5;cursor:not-allowed;}
.search-bar{display:flex;gap:14px;margin-bottom:18px;flex-wrap:wrap;}
.search-bar input{flex:1;min-width:200px;}
.filter-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;}
.filter-btn{padding:8px 18px;border:1px solid #334155;background:transparent;color:#94a3b8;border-radius:20px;cursor:pointer;font-size:0.95rem;transition:all 0.2s;}
.filter-btn.active{border-color:#f97316;color:#f97316;background:rgba(249,115,22,0.1);}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:0.95rem;}
th{background:#0f172a;padding:13px 16px;text-align:left;color:#94a3b8;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid #334155;white-space:nowrap;}
td{padding:13px 16px;border-bottom:1px solid #1e293b;vertical-align:middle;}
tr:hover td{background:rgba(255,255,255,0.02);}
.status-badge{display:inline-flex;align-items:center;gap:5px;padding:5px 14px;border-radius:12px;font-size:0.875rem;font-weight:600;white-space:nowrap;}
.status-winning{background:rgba(16,185,129,0.15);color:#10b981;border:1px solid rgba(16,185,129,0.3);}
.status-losing{background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);}
.status-amazon{background:rgba(59,130,246,0.15);color:#3b82f6;border:1px solid rgba(59,130,246,0.3);}
.status-unknown{background:rgba(148,163,184,0.15);color:#94a3b8;border:1px solid rgba(148,163,184,0.3);}
.product-img{width:50px;height:50px;object-fit:contain;border-radius:4px;background:#0f172a;}
.no-img{width:40px;height:40px;background:#334155;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;}
.asin-code{font-family:monospace;font-size:0.8rem;color:#94a3b8;}
.price-val{font-weight:700;color:#a78bfa;}
.seller-name{font-weight:600;}
.seller-me{color:#10b981;}
.seller-amazon{color:#3b82f6;}
.seller-other{color:#f97316;}
.page{display:none;}
.page.active{display:block;}
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:20px;}
.chart-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px;}
.chart-card h3{font-size:0.9rem;color:#94a3b8;margin-bottom:16px;}
.bar-chart{display:flex;flex-direction:column;gap:10px;}
.bar-row{display:flex;align-items:center;gap:10px;}
.bar-label{width:120px;font-size:0.8rem;color:#e2e8f0;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bar-track{flex:1;height:24px;background:#0f172a;border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;font-size:0.75rem;font-weight:600;color:#fff;transition:width 0.5s;}
.pie-row{display:flex;align-items:center;justify-content:space-around;flex-wrap:wrap;gap:16px;}
.pie-item{text-align:center;}
.pie-circle{width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:800;margin:0 auto 8px;}
.history-table{font-size:0.8rem;}
.history-table td{padding:7px 10px;}
.change-up{color:#ef4444;}
.change-down{color:#10b981;}
.change-none{color:#94a3b8;}
.loading{display:inline-block;width:16px;height:16px;border:2px solid #334155;border-top-color:#f97316;border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes spin{to{transform:rotate(360deg);}}
.alert{padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:0.875rem;}
.alert-success{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#10b981;}
.alert-error{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;}
.alert-info{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);color:#3b82f6;}
.product-detail{background:#0f172a;border:1px solid #334155;border-radius:8px;padding:16px;margin-top:16px;}
.detail-grid{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:start;}
.detail-img{width:100px;height:100px;object-fit:contain;border-radius:8px;}
.detail-info h3{font-size:1rem;font-weight:600;margin-bottom:8px;}
.detail-row{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;}
.detail-item{text-align:center;background:#1e293b;padding:10px 16px;border-radius:8px;min-width:100px;}
.detail-item .d-val{font-size:1.1rem;font-weight:700;}
.detail-item .d-lbl{font-size:0.7rem;color:#94a3b8;margin-top:2px;}
.progress-bar{height:6px;background:#0f172a;border-radius:3px;margin-top:8px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;background:#f97316;}
.empty-state{text-align:center;padding:60px 20px;color:#475569;}
.empty-state .icon{font-size:3rem;margin-bottom:12px;}
.empty-state p{font-size:0.9rem;}
.bulk-result{margin-top:12px;}
.tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.75rem;margin:2px;background:#334155;color:#94a3b8;}
</style>
</head>
<body>
<div class="header">
  <h1>📦 Amazon <span>Buybox</span> Tracker</h1>
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="nav">
      <button class="nav-btn active" onclick="showPage('dashboard')">🏠 Dashboard</button>
      <button class="nav-btn" onclick="showPage('lookup')">🔍 Lookup</button>
      <button class="nav-btn" onclick="showPage('bulk')">📋 Bulk Upload</button>
      <button class="nav-btn" onclick="showPage('analytics')">📊 Analytics</button>
      <button class="nav-btn" onclick="showPage('settings')">⚙️ Settings</button>
    </div>
    <span id="backendBadge" class="badge badge-offline">⚫ Offline</span>
  </div>
</div>

<div class="main">

<!-- DASHBOARD PAGE -->
<div id="page-dashboard" class="page active">
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card"><div class="val val-win" id="s-winning">0</div><div class="lbl">🏆 Winning</div></div>
    <div class="stat-card"><div class="val val-lose" id="s-losing">0</div><div class="lbl">😞 Losing</div></div>
    <div class="stat-card"><div class="val val-amazon" id="s-amazon">0</div><div class="lbl">🛒 Amazon Wins</div></div>
    <div class="stat-card"><div class="val val-total" id="s-total">0</div><div class="lbl">📦 Total Tracked</div></div>
    <div class="stat-card"><div class="val val-price" id="s-avgprice">R0</div><div class="lbl">💰 Avg Buybox Price</div></div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h2>📋 Tracked Products</h2>
      <button class="btn btn-primary btn-sm" onclick="refreshAll()">🔄 Refresh All</button>
    </div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="🔍 Search by title, ASIN or seller..." oninput="applyFilters()"/>
    </div>
    <div class="filter-row">
      <span style="font-size:0.8rem;color:#94a3b8;align-self:center;">Filter:</span>
      <button class="filter-btn active" onclick="setFilter('all',this)">All</button>
      <button class="filter-btn" onclick="setFilter('winning',this)">🏆 Winning</button>
      <button class="filter-btn" onclick="setFilter('losing',this)">😞 Losing</button>
      <button class="filter-btn" onclick="setFilter('amazon',this)">🛒 Amazon</button>
    </div>
    <div id="alertBox"></div>
    <div class="table-wrap">
      <table id="productsTable">
        <thead>
          <tr>
            <th></th>
            <th onclick="sortTable('title')" style="cursor:pointer;">Product ↕</th>
            <th onclick="sortTable('asin')" style="cursor:pointer;">ASIN ↕</th>
            <th onclick="sortTable('sku')" style="cursor:pointer;">SKU ↕</th>
            <th onclick="sortTable('my_price')" style="cursor:pointer;">My Price ↕</th>
            <th onclick="sortTable('my_stock')" style="cursor:pointer;">Stock ↕</th>
            <th onclick="sortTable('buybox_price')" style="cursor:pointer;">Buybox Price ↕</th>
            <th onclick="sortTable('buybox_seller')" style="cursor:pointer;">Buybox Seller ↕</th>
            <th>Status</th>
            <th onclick="sortTable('scraped_at')" style="cursor:pointer;">Last Checked ↕</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="productsBody">
          <tr><td colspan="8"><div class="empty-state"><div class="icon">📦</div><p>No products tracked yet.<br>Use Lookup or Bulk Upload to add ASINs.</p></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- LOOKUP PAGE -->
<div id="page-lookup" class="page">
  <div class="card">
    <h2>🔍 Single ASIN Lookup</h2>
    <div class="form-row">
      <div class="form-group">
        <label>ASIN</label>
        <input type="text" id="asinInput" placeholder="e.g. B01ARH3Q5G" style="width:220px;" onkeydown="if(event.key==='Enter')fetchBuybox()"/>
      </div>
      <div class="form-group">
        <label>Marketplace</label>
        <select id="marketSelect">
          <option value="amazon.co.za" selected>🇿🇦 Amazon SA</option>
          <option value="amazon.co.uk">🇬🇧 Amazon UK</option>
          <option value="amazon.com">🇺🇸 Amazon US</option>
          <option value="amazon.de">🇩🇪 Amazon DE</option>
          <option value="amazon.fr">🇫🇷 Amazon FR</option>
          <option value="amazon.ca">🇨🇦 Amazon CA</option>
          <option value="amazon.com.au">🇦🇺 Amazon AU</option>
        </select>
      </div>
      <div class="form-group" style="justify-content:flex-end;">
        <button class="btn btn-primary" id="fetchBtn" onclick="fetchBuybox()">🔍 Fetch Buybox</button>
      </div>
    </div>
    <div id="lookupAlert" style="margin-top:12px;"></div>
    <div id="productDetail"></div>
  </div>
  <div class="card" id="historyCard" style="display:none;">
    <h2>🕐 Price History</h2>
    <div class="table-wrap">
      <table class="history-table">
        <thead><tr><th>Time</th><th>Price</th><th>Seller</th><th>Status</th><th>Change</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- BULK PAGE -->
<div id="page-bulk" class="page">

  <!-- Excel Import Card -->
  <div class="card">
    <h2>📥 Import from Excel / CSV</h2>
    <p style="color:#94a3b8;font-size:0.9rem;margin-bottom:16px;">Upload your Excel or CSV file with ASIN, SKU, My Price and Stock Level. New ASINs will be added; existing ones will have their SKU/Price/Stock updated.</p>
    <div style="background:#1a2e44;border:1px solid #2563eb;border-radius:8px;padding:14px;margin-bottom:18px;font-size:0.9rem;color:#93c5fd;">
      <b>📋 Required columns (any order, flexible naming):</b><br><br>
      <code style="background:#0f172a;padding:3px 8px;border-radius:4px;">ASIN</code> &nbsp;
      <code style="background:#0f172a;padding:3px 8px;border-radius:4px;">SKU</code> &nbsp;
      <code style="background:#0f172a;padding:3px 8px;border-radius:4px;">My Price</code> or <code style="background:#0f172a;padding:3px 8px;border-radius:4px;">Price</code> &nbsp;
      <code style="background:#0f172a;padding:3px 8px;border-radius:4px;">Stock</code> or <code style="background:#0f172a;padding:3px 8px;border-radius:4px;">Qty</code><br><br>
      Supports <b>.xlsx</b>, <b>.xls</b> and <b>.csv</b> files. Example row:<br>
      <code style="background:#0f172a;padding:3px 8px;border-radius:4px;display:inline-block;margin-top:6px;">B01ARGZ8N0 | SKU-CANON-001 | 1599.00 | 25</code>
    </div>
    <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap;">
      <input type="file" id="excelFile" accept=".xlsx,.xls,.csv"
        style="background:#0f172a;border:1px solid #334155;color:#e2e8f0;padding:10px;border-radius:8px;font-size:0.9rem;flex:1;min-width:200px;"/>
      <button class="btn btn-primary" onclick="importExcel()">📤 Import File</button>
      <a href="#" onclick="downloadTemplate()" style="color:#f97316;font-size:0.85rem;text-decoration:none;">⬇️ Download Template</a>
    </div>
    <div id="importAlert" style="margin-top:12px;"></div>
    <div id="importResult" style="margin-top:12px;"></div>
  </div>

  <!-- Bulk Scrape Card -->
  <div class="card">
    <h2>📋 Bulk ASIN / URL Scrape</h2>
    <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:16px;">Paste one ASIN or Amazon URL per line. Chrome Extension will open each in a tab and scrape buybox data automatically.</p>
    <div class="form-group" style="margin-bottom:12px;">
      <label>Marketplace</label>
      <select id="bulkMarket" style="width:200px;">
        <option value="amazon.co.za" selected>🇿🇦 Amazon SA</option>
        <option value="amazon.co.uk">🇬🇧 Amazon UK</option>
        <option value="amazon.com">🇺🇸 Amazon US</option>
        <option value="amazon.de">🇩🇪 Amazon DE</option>
        <option value="amazon.fr">🇫🇷 Amazon FR</option>
        <option value="amazon.ca">🇨🇦 Amazon CA</option>
        <option value="amazon.com.au">🇦🇺 Amazon AU</option>
      </select>
    </div>
    <textarea id="bulkInput" placeholder="B01ARH3Q5G&#10;B01ARH7R7Y&#10;https://www.amazon.co.za/dp/B09XYZ1234&#10;..."></textarea>
    <div style="display:flex;gap:12px;margin-top:12px;">
      <button class="btn btn-primary" id="bulkBtn" onclick="submitBulk()">🚀 Fetch All via Extension</button>
      <button class="btn btn-sm" style="background:#334155;color:#e2e8f0;" onclick="document.getElementById('bulkInput').value=''">🗑 Clear</button>
    </div>
    <div id="bulkAlert" style="margin-top:12px;"></div>
    <div id="bulkResult" class="bulk-result"></div>
  </div>
</div>

<!-- ANALYTICS PAGE -->
<div id="page-analytics" class="page">
  <div class="analytics-grid">
    <div class="chart-card">
      <h3>🏆 Buybox Distribution</h3>
      <div class="pie-row" id="pieChart">
        <div class="empty-state" style="padding:20px;"><p>No data yet</p></div>
      </div>
    </div>
    <div class="chart-card">
      <h3>💰 Top Prices (Highest Buybox)</h3>
      <div class="bar-chart" id="topPricesChart"></div>
    </div>
    <div class="chart-card">
      <h3>🛒 Sellers Winning Buybox</h3>
      <div class="bar-chart" id="sellersChart"></div>
    </div>
    <div class="chart-card">
      <h3>📈 Win Rate Summary</h3>
      <div id="winRatePanel"></div>
    </div>
  </div>
  <div class="card">
    <h2>📊 All Products Snapshot</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>#</th><th>Product</th><th>ASIN</th><th>Price</th><th>Seller</th><th>Status</th><th>Rating</th><th>Last Checked</th></tr>
        </thead>
        <tbody id="analyticsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- SETTINGS PAGE -->
<div id="page-settings" class="page">
  <div class="card">
    <h2>📱 WhatsApp Alerts (via CallMeBot - Free)</h2>
    <p style="color:#94a3b8;margin-bottom:18px;font-size:1rem;">Get WhatsApp messages when you lose or win the buybox. Uses free CallMeBot service.</p>
    <div style="background:#1e3a5f;border:1px solid #3b82f6;border-radius:8px;padding:16px;margin-bottom:20px;font-size:0.95rem;color:#93c5fd;">
      <b>📋 Setup Instructions:</b><br><br>
      1. Save this number in your phone: <b>+34 644 52 74 61</b> (CallMeBot)<br>
      2. Send this WhatsApp message to that number: <b>I allow callmebot to send me messages</b><br>
      3. You'll receive an API key via WhatsApp within a minute<br>
      4. Enter your number and API key below, then click Save
    </div>
    <div class="form-row" style="margin-bottom:16px;">
      <div class="form-group" style="flex:1;">
        <label>Your WhatsApp Number (with country code, no +)</label>
        <input type="text" id="waPhone" placeholder="27821234567" />
      </div>
      <div class="form-group" style="flex:1;">
        <label>CallMeBot API Key</label>
        <input type="text" id="waApiKey" placeholder="Your API key from CallMeBot" />
      </div>
    </div>
    <div class="form-row" style="margin-bottom:16px;">
      <div class="form-group">
        <label>Alert me when:</label>
        <div style="display:flex;gap:16px;margin-top:8px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:#e2e8f0;">
            <input type="checkbox" id="alertLosing" checked style="width:18px;height:18px;" /> 😞 I lose the buybox
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:#e2e8f0;">
            <input type="checkbox" id="alertWinning" checked style="width:18px;height:18px;" /> 🏆 I win the buybox
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:#e2e8f0;">
            <input type="checkbox" id="alertAmazon" checked style="width:18px;height:18px;" /> 🛒 Amazon takes buybox
          </label>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:12px;">
      <button class="btn btn-primary" onclick="saveAlertSettings()">💾 Save Settings</button>
      <button class="btn" style="background:#1e293b;border:1px solid #334155;color:#e2e8f0;" onclick="testWhatsApp()">📤 Send Test Message</button>
    </div>
    <div id="alertSettingsMsg" style="margin-top:12px;"></div>
  </div>

  <div class="card">
    <h2>💬 Telegram Alerts (Free &amp; Instant)</h2>
    <p style="color:#94a3b8;margin-bottom:18px;font-size:1rem;">Get Telegram messages when you lose or win the buybox. Uses the free Telegram Bot API — no third-party service needed.</p>
    <div style="background:#1a2e44;border:1px solid #2563eb;border-radius:8px;padding:16px;margin-bottom:20px;font-size:0.95rem;color:#93c5fd;">
      <b>📋 Setup Instructions:</b><br><br>
      1. Open Telegram and search for <b>@BotFather</b><br>
      2. Send <b>/newbot</b> and follow the prompts — BotFather will give you a <b>Bot Token</b><br>
      3. Start a chat with your new bot (or add it to a group)<br>
      4. Visit <b>https://api.telegram.org/bot&lt;YOUR_TOKEN&gt;/getUpdates</b> in your browser — find the <b>"id"</b> value inside the <b>"chat"</b> object — that's your Chat ID<br>
      5. Enter the token and chat ID below and click Save, then Test
    </div>
    <div class="form-row" style="margin-bottom:16px;">
      <div class="form-group" style="flex:1;">
        <label>Bot Token (from @BotFather)</label>
        <input type="text" id="tgBotToken" placeholder="123456789:ABCdefGHIjklMNOpqrSTUvwxYZ" />
      </div>
      <div class="form-group" style="flex:1;">
        <label>Chat ID (your personal or group chat)</label>
        <input type="text" id="tgChatId" placeholder="123456789 or -100123456789 for groups" />
        <button class="btn" style="margin-top:8px;background:#0f172a;border:1px solid #2563eb;color:#93c5fd;font-size:13px;padding:6px 14px;" onclick="fetchTelegramChatId()">🔍 Auto-Detect Chat ID</button>
        <div id="tgChatIdMsg" style="margin-top:6px;font-size:0.85rem;color:#94a3b8;">Paste your Bot Token above, send <b>/start</b> to your bot in Telegram, then click Auto-Detect.</div>
      </div>
    </div>
    <div style="display:flex;gap:12px;">
      <button class="btn btn-primary" onclick="saveAlertSettings()">💾 Save Settings</button>
      <button class="btn" style="background:#1e293b;border:1px solid #2563eb;color:#93c5fd;" onclick="testTelegram()">📤 Send Test Telegram</button>
    </div>
    <div id="telegramSettingsMsg" style="margin-top:12px;"></div>
  </div>

  <div class="card">
    <h2>🔄 Auto-Refresh Scheduler</h2>
    <p style="color:#94a3b8;margin-bottom:18px;font-size:1rem;">Automatically refresh buybox data for all tracked ASINs on a schedule.</p>
    <div id="schedulerStatus" style="background:#0f172a;border-radius:8px;padding:16px;margin-bottom:18px;font-size:1rem;color:#94a3b8;">Loading scheduler status...</div>
    <div class="form-row" style="margin-bottom:16px;">
      <div class="form-group">
        <label>Refresh Interval</label>
        <select id="refreshInterval">
          <option value="1">Every 1 hour</option>
          <option value="2">Every 2 hours</option>
          <option value="4">Every 4 hours</option>
          <option value="6" selected>Every 6 hours</option>
          <option value="12">Every 12 hours</option>
          <option value="24">Every 24 hours</option>
        </select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="schedulerEnabled">
          <option value="true">✅ Enabled</option>
          <option value="false">⏸ Disabled</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:12px;">
      <button class="btn btn-primary" onclick="saveSchedulerSettings()">💾 Save Schedule</button>
      <button class="btn" style="background:#1e293b;border:1px solid #10b981;color:#10b981;" onclick="runNow()">⚡ Refresh All Now</button>
    </div>
    <div id="schedulerMsg" style="margin-top:12px;"></div>
  </div>
</div>

</div><!-- end main -->
</body>
<script>
// Auto-detect API URL: use same host when deployed, fallback to localhost for local dev
const API = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
  ? 'http://localhost:8001'
  : window.location.origin;
const MY_SELLER = 'Bonolo Online';
const CURRENCY = {'amazon.co.za':'R','amazon.co.uk':'£','amazon.com':'$','amazon.de':'€','amazon.fr':'€','amazon.ca':'C$','amazon.com.au':'A$'};

let allProducts = [];
let currentFilter = 'all';
let sortCol = 'scraped_at';
let sortDir = -1;

// ── Page Navigation ──────────────────────────────────────────────
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'dashboard') loadDashboard();
  if (name === 'analytics') loadAnalytics();
  if (name === 'settings') loadSettings();
}

// ── Health Check ─────────────────────────────────────────────────
async function checkHealth() {
  try {
    const r = await fetch(API + '/api/health');
    const d = await r.json();
    const b = document.getElementById('backendBadge');
    b.textContent = '🟢 Backend Online';
    b.className = 'badge badge-online';
  } catch(e) {
    const b = document.getElementById('backendBadge');
    b.textContent = '🔴 Backend Offline';
    b.className = 'badge badge-offline';
  }
}

// ── Format helpers ────────────────────────────────────────────────
function fmtPrice(p, market) {
  if (!p) return '<span style="color:#475569">—</span>';
  const sym = CURRENCY[market] || 'R';
  return `<span class="price-val">${sym}${Number(p).toLocaleString('en-ZA',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>`;
}
function fmtSeller(seller, status) {
  if (!seller || seller === 'Unknown') return '<span style="color:#475569">Unknown</span>';
  const cls = status === 'winning' ? 'seller-me' : status === 'amazon' ? 'seller-amazon' : 'seller-other';
  return `<span class="seller-name ${cls}">${seller}</span>`;
}
function fmtStatus(status, seller) {
  const map = {
    winning: `<span class="status-badge status-winning">🏆 Winning</span>`,
    losing:  `<span class="status-badge status-losing">😞 Losing</span>`,
    amazon:  `<span class="status-badge status-amazon">🛒 Amazon</span>`,
    unknown: `<span class="status-badge status-unknown">❓ Unknown</span>`,
  };
  return map[status] || map.unknown;
}
function fmtTime(iso) {
  if (!iso) return '—';
  const d = new Date(iso);
  return d.toLocaleString('en-ZA');
}
function fmtImg(url) {
  if (!url) return `<div class="no-img">📦</div>`;
  return `<img class="product-img" src="${url}" onerror="this.style.display='none'"/>`;
}
function showAlert(id, msg, type='info') {
  document.getElementById(id).innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
}
function clearAlert(id) { document.getElementById(id).innerHTML = ''; }

// ── Load Dashboard ────────────────────────────────────────────────
async function loadDashboard() {
  try {
    const r = await fetch(API + '/api/buybox/tracked');
    const d = await r.json();
    allProducts = d.asins || [];
    updateStats();
    renderTable();
  } catch(e) {
    showAlert('alertBox', '❌ Cannot connect to backend. If running locally, make sure the backend is running on port 8001. If deployed, the server may be starting up — please wait a moment and refresh.', 'error');
  }
}

function updateStats() {
  const winning = allProducts.filter(p => p.buybox_status === 'winning').length;
  const losing  = allProducts.filter(p => p.buybox_status === 'losing').length;
  const amazon  = allProducts.filter(p => p.buybox_status === 'amazon').length;
  const total   = allProducts.length;
  const prices  = allProducts.filter(p => p.buybox_price).map(p => p.buybox_price);
  const avg     = prices.length ? (prices.reduce((a,b)=>a+b,0)/prices.length) : 0;

  document.getElementById('s-winning').textContent = winning;
  document.getElementById('s-losing').textContent  = losing;
  document.getElementById('s-amazon').textContent  = amazon;
  document.getElementById('s-total').textContent   = total;
  document.getElementById('s-avgprice').textContent = `R${avg.toLocaleString('en-ZA',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
}

// ── Filters & Search ──────────────────────────────────────────────
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTable();
}

function applyFilters() { renderTable(); }

function sortTable(col) {
  if (sortCol === col) sortDir *= -1;
  else { sortCol = col; sortDir = -1; }
  renderTable();
}

function renderTable() {
  const search = (document.getElementById('searchInput').value || '').toLowerCase();
  let data = allProducts.filter(p => {
    if (currentFilter !== 'all' && p.buybox_status !== currentFilter) return false;
    if (search) {
      const hay = `${p.title||''} ${p.asin||''} ${p.buybox_seller||''}`.toLowerCase();
      if (!hay.includes(search)) return false;
    }
    return true;
  });

  data.sort((a, b) => {
    let va = a[sortCol] || '';
    let vb = b[sortCol] || '';
    if (typeof va === 'number') return (va - vb) * sortDir;
    return String(va).localeCompare(String(vb)) * sortDir;
  });

  const tbody = document.getElementById('productsBody');
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="icon">🔍</div><p>No products match your search/filter.</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(p => {
    const priceDiff = (p.my_price && p.buybox_price) ? p.buybox_price - p.my_price : null;
    const priceDiffHtml = priceDiff !== null
      ? `<div style="font-size:0.7rem;margin-top:2px;color:${priceDiff > 0 ? '#10b981' : priceDiff < 0 ? '#ef4444' : '#94a3b8'};">${priceDiff > 0 ? '▲ Buybox higher' : priceDiff < 0 ? '▼ Buybox lower' : '= Same price'}</div>`
      : '';
    const stockHtml = p.my_stock !== null && p.my_stock !== undefined
      ? `<span style="color:${p.my_stock > 10 ? '#10b981' : p.my_stock > 0 ? '#f59e0b' : '#ef4444'};font-weight:600;">${p.my_stock}</span>`
      : '<span style="color:#475569">—</span>';
    return `
    <tr>
      <td>${fmtImg(p.image_url)}</td>
      <td style="max-width:220px;">
        <div style="font-weight:500;font-size:0.85rem;line-height:1.4;">${p.title || '—'}</div>
        <a href="${p.url}" target="_blank" style="font-size:0.75rem;color:#f97316;">View on Amazon ↗</a>
      </td>
      <td><span class="asin-code">${p.asin}</span></td>
      <td><span style="font-family:monospace;font-size:0.8rem;color:#94a3b8;">${p.sku || '—'}</span></td>
      <td>${p.my_price ? `<span class="price-val" style="color:#34d399;">${CURRENCY[p.marketplace]||'R'}${Number(p.my_price).toLocaleString('en-ZA',{minimumFractionDigits:2})}</span>${priceDiffHtml}` : '<span style="color:#475569">—</span>'}</td>
      <td>${stockHtml}</td>
      <td>${fmtPrice(p.buybox_price, p.marketplace)}</td>
      <td>${fmtSeller(p.buybox_seller, p.buybox_status)}</td>
      <td>${fmtStatus(p.buybox_status)}</td>
      <td style="font-size:0.8rem;color:#94a3b8;">${fmtTime(p.scraped_at)}</td>
      <td>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-primary btn-sm" title="Refresh via Extension" onclick="quickRefresh('${p.asin}','${p.marketplace}')">🔄</button>
          <button class="btn btn-sm" style="background:#334155;color:#e2e8f0;" title="View Price History" onclick="viewHistory('${p.asin}')">📈</button>
          <button class="btn btn-danger btn-sm" title="Remove" onclick="removeASIN('${p.asin}')">🗑</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// ── Refresh via Extension (open tab, auto-scrape, close) ─────────
async function quickRefresh(asin, market) {
  showAlert('alertBox', `<span class="loading"></span>Opening ${asin} for auto-scrape — tab will close automatically...`, 'info');

  // Record the old scraped_at so we detect when a NEW scrape comes in
  const oldProduct = allProducts.find(p => p.asin === asin);
  const oldScrapedAt = oldProduct ? oldProduct.scraped_at : null;

  // Build the Amazon product URL with ?auto_scrape=1 flag
  const domain = (market || 'amazon.co.za').replace('www.', '');
  const productUrl = `https://www.${domain}/dp/${asin}?auto_scrape=1`;

  // Open tab — extension content.js detects auto_scrape=1, scrapes, pushes to backend, closes tab
  window.open(productUrl, '_blank');

  // Poll backend every 3s — detect when scraped_at changes (new scrape arrived)
  let attempts = 0;
  const maxAttempts = 20; // 20 × 3s = 60s timeout
  const poll = setInterval(async () => {
    attempts++;
    try {
      const r = await fetch(API + '/api/buybox/tracked');
      const d = await r.json();
      const updated = (d.asins || []).find(p => p.asin === asin);
      if (updated) {
        // Detect new scrape: scraped_at changed OR was null before and now has a value
        const isNew = updated.scraped_at && updated.scraped_at !== oldScrapedAt;
        if (isNew) {
          clearInterval(poll);
          const idx = allProducts.findIndex(p => p.asin === asin);
          if (idx >= 0) allProducts[idx] = updated; else allProducts.push(updated);
          updateStats(); renderTable();
          const price = updated.buybox_price ? 'R' + Number(updated.buybox_price).toLocaleString('en-ZA', {minimumFractionDigits:2}) : 'N/A';
          showAlert('alertBox', `✅ ${asin} refreshed — Seller: <b>${updated.buybox_seller || 'Unknown'}</b>, Price: <b>${price}</b>, Status: ${updated.buybox_status || 'unknown'}`, 'success');
          return;
        }
      }
    } catch(e) {}
    if (attempts >= maxAttempts) {
      clearInterval(poll);
      showAlert('alertBox', `⚠️ Timeout for ${asin}. Make sure: 1) Extension is installed & enabled, 2) Backend URL is set in extension Settings tab, 3) Allow pop-ups for this site.`, 'error');
    }
  }, 3000);
}

async function refreshAll() {
  if (!allProducts.length) { showAlert('alertBox', '⚠️ No products tracked yet.', 'error'); return; }
  showAlert('alertBox', `<span class="loading"></span>Opening tabs for all ${allProducts.length} products — extension will scrape each one...`, 'info');
  // Open tabs one at a time with a delay to avoid overwhelming Amazon
  let i = 0;
  const openNext = () => {
    if (i >= allProducts.length) {
      setTimeout(() => loadDashboard(), 5000);
      return;
    }
    const p = allProducts[i++];
    const domain = p.marketplace || 'amazon.co.za';
    const url = `https://www.${domain}/dp/${p.asin}?auto_scrape=1&dashboard=${encodeURIComponent(window.location.origin)}`;
    window.open(url, '_blank');
    setTimeout(openNext, 3000); // 3s between tabs
  };
  openNext();
  showAlert('alertBox', `⏳ Opening ${allProducts.length} tabs (3s apart). Extension will scrape each and close the tab. Dashboard reloads in ~${allProducts.length * 3 + 10}s`, 'info');
  setTimeout(() => loadDashboard(), (allProducts.length * 3 + 10) * 1000);
}

async function removeASIN(asin) {
  if (!confirm(`Remove ${asin} from tracking?`)) return;
  await fetch(API + '/api/buybox/tracked/' + asin, {method:'DELETE'});
  allProducts = allProducts.filter(p => p.asin !== asin);
  updateStats(); renderTable();
}

// ── Single Lookup — via Chrome Extension ─────────────────────────
async function fetchBuybox() {
  const asin = document.getElementById('asinInput').value.trim().toUpperCase();
  const market = document.getElementById('marketSelect').value;
  if (!asin || !/^[A-Z0-9]{10}$/.test(asin)) { showAlert('lookupAlert','⚠️ Please enter a valid 10-character ASIN (e.g. B01ARH3Q5G)','error'); return; }

  const btn = document.getElementById('fetchBtn');
  btn.disabled = true; btn.innerHTML = '<span class="loading"></span>Opening tab...';
  showAlert('lookupAlert', `<span class="loading"></span>Opening Amazon tab for <b>${asin}</b> — Chrome Extension will scrape it automatically...`, 'info');
  document.getElementById('productDetail').innerHTML = '';
  document.getElementById('historyCard').style.display = 'none';

  // Get the old scraped_at so we detect when a fresh scrape arrives
  const oldProduct = allProducts.find(p => p.asin === asin);
  const oldScrapedAt = oldProduct ? oldProduct.scraped_at : null;

  const domain = market.replace('www.','');
  window.open(`https://www.${domain}/dp/${asin}?auto_scrape=1&dashboard=${encodeURIComponent(window.location.origin)}`, '_blank');

  let attempts = 0;
  const maxAttempts = 20;
  const poll = setInterval(async () => {
    attempts++;
    try {
      const r = await fetch(API + '/api/buybox/tracked');
      const d = await r.json();
      const updated = (d.asins || []).find(p => p.asin === asin);
      if (updated && updated.scraped_at && updated.scraped_at !== oldScrapedAt) {
        clearInterval(poll);
        btn.disabled = false; btn.innerHTML = '🔍 Fetch Buybox';
        clearAlert('lookupAlert');
        renderProductDetail(updated);
        fetchHistory(asin);
        const idx = allProducts.findIndex(p => p.asin === asin);
        if (idx >= 0) allProducts[idx] = updated; else allProducts.push(updated);
        updateStats(); renderTable();
        return;
      }
    } catch(e) {}
    if (attempts >= maxAttempts) {
      clearInterval(poll);
      btn.disabled = false; btn.innerHTML = '🔍 Fetch Buybox';
      showAlert('lookupAlert', `⚠️ Timeout for ${asin}. Make sure the Chrome Extension is installed, enabled, and your backend URL is set in extension Settings.`, 'error');
    }
  }, 3000);
}

function renderProductDetail(d) {
  const sym = CURRENCY[d.marketplace] || 'R';
  const statusClass = {winning:'status-winning',losing:'status-losing',amazon:'status-amazon',unknown:'status-unknown'}[d.buybox_status] || 'status-unknown';
  const statusLabel = {winning:'🏆 WINNING - Buybox is yours!',losing:'😞 LOSING - Someone else has buybox',amazon:'🛒 AMAZON - Amazon holds the buybox',unknown:'❓ Unknown'}[d.buybox_status] || '❓ Unknown';
  const sellerClass = d.buybox_status==='winning'?'seller-me':d.buybox_status==='amazon'?'seller-amazon':'seller-other';

  document.getElementById('productDetail').innerHTML = `
    <div class="product-detail">
      <div class="detail-grid">
        ${d.image_url ? `<img class="detail-img" src="${d.image_url}"/>` : `<div style="font-size:3rem;">📦</div>`}
        <div>
          <h3>${d.title || 'Unknown Product'}</h3>
          <div style="margin:6px 0;"><span class="asin-code">${d.asin}</span> · <a href="${d.url}" target="_blank" style="color:#f97316;font-size:0.8rem;">View on Amazon ↗</a></div>
          <div><span class="status-badge ${statusClass}">${statusLabel}</span></div>
          <div class="detail-row">
            <div class="detail-item">
              <div class="d-val" style="color:#a78bfa;">${d.buybox_price ? sym+Number(d.buybox_price).toLocaleString('en-ZA',{minimumFractionDigits:2}) : '—'}</div>
              <div class="d-lbl">Buybox Price</div>
            </div>
            <div class="detail-item">
              <div class="d-val ${sellerClass}">${d.buybox_seller || 'Unknown'}</div>
              <div class="d-lbl">Buybox Seller</div>
            </div>
            <div class="detail-item">
              <div class="d-val" style="color:#fbbf24;">${d.rating ? '⭐ '+d.rating : '—'}</div>
              <div class="d-lbl">${d.review_count ? d.review_count+' reviews' : 'Rating'}</div>
            </div>
            <div class="detail-item">
              <div class="d-val" style="color:#94a3b8;font-size:0.85rem;">${d.availability || '—'}</div>
              <div class="d-lbl">Availability</div>
            </div>
          </div>
        </div>
      </div>
    </div>`;
}

async function fetchHistory(asin) {
  try {
    const r = await fetch(API + '/api/buybox/history/' + asin);
    const d = await r.json();
    const history = d.history || [];
    if (!history.length) return;
    document.getElementById('historyCard').style.display = 'block';
    const rows = [...history].reverse().map((h, i, arr) => {
      const prev = arr[i+1];
      let change = '<span class="change-none">—</span>';
      if (prev && prev.price && h.price) {
        const diff = h.price - prev.price;
        if (diff > 0) change = `<span class="change-up">▲ R${diff.toFixed(2)}</span>`;
        else if (diff < 0) change = `<span class="change-down">▼ R${Math.abs(diff).toFixed(2)}</span>`;
        else change = `<span class="change-none">No change</span>`;
      }
      const statusBadge = fmtStatus(h.status);
      return `<tr><td>${fmtTime(h.timestamp)}</td><td class="price-val">R${Number(h.price).toLocaleString('en-ZA',{minimumFractionDigits:2})}</td><td>${fmtSeller(h.seller,h.status)}</td><td>${statusBadge}</td><td>${change}</td></tr>`;
    });
    document.getElementById('historyBody').innerHTML = rows.join('');
  } catch(e) {}
}

async function viewHistory(asin) {
  showPage('lookup');
  document.querySelectorAll('.nav-btn')[1].classList.add('active');
  document.querySelectorAll('.nav-btn')[0].classList.remove('active');
  document.getElementById('asinInput').value = asin;
  fetchHistory(asin);
}

// ── Excel Import ─────────────────────────────────────────────────
async function importExcel() {
  const fileInput = document.getElementById('excelFile');
  const file = fileInput.files[0];
  if (!file) { showAlert('importAlert', '⚠️ Please select a file first.', 'error'); return; }

  const ext = file.name.split('.').pop().toLowerCase();
  if (!['xlsx','xls','csv'].includes(ext)) {
    showAlert('importAlert', '❌ Only .xlsx, .xls or .csv files are supported.', 'error'); return;
  }

  showAlert('importAlert', `<span class="loading"></span>Uploading <b>${file.name}</b>...`, 'info');
  document.getElementById('importResult').innerHTML = '';

  const formData = new FormData();
  formData.append('file', file);

  try {
    const r = await fetch(API + '/api/import/excel', { method: 'POST', body: formData });
    const d = await r.json();
    if (!r.ok) {
      showAlert('importAlert', `❌ Import failed: ${d.detail || 'Unknown error'}`, 'error');
      return;
    }
    showAlert('importAlert', `✅ ${d.message || 'Import complete'}`, 'success');

    // Show detailed results
    const skippedHtml = d.skipped_records && d.skipped_records.length > 0 ? `
      <div style="margin-top:10px;background:#ef444411;border:1px solid #ef444433;border-radius:8px;padding:10px 14px;">
        <div style="font-size:0.8rem;color:#ef4444;font-weight:600;margin-bottom:4px;">⚠️ ${d.skipped} rows skipped:</div>
        ${d.skipped_records.slice(0,10).map(s=>`<div style="font-size:0.75rem;color:#94a3b8;">${s.reason}</div>`).join('')}
        ${d.skipped_records.length > 10 ? `<div style="font-size:0.75rem;color:#94a3b8;">...and ${d.skipped_records.length-10} more</div>` : ''}
      </div>` : '';

    const recordsHtml = d.records && d.records.length > 0 ? `
      <table style="width:100%;font-size:0.82rem;border-collapse:collapse;margin-top:12px;">
        <thead><tr style="background:#0f172a;">
          <th style="padding:8px;text-align:left;color:#94a3b8;">ASIN</th>
          <th style="padding:8px;text-align:left;color:#94a3b8;">SKU</th>
          <th style="padding:8px;text-align:left;color:#94a3b8;">My Price</th>
          <th style="padding:8px;text-align:left;color:#94a3b8;">Stock</th>
        </tr></thead>
        <tbody>${d.records.slice(0,20).map(rec=>`
          <tr style="border-bottom:1px solid #1e293b;">
            <td style="padding:8px;font-family:monospace;color:#94a3b8;">${rec.asin}</td>
            <td style="padding:8px;color:#e2e8f0;">${rec.sku || '—'}</td>
            <td style="padding:8px;color:#34d399;">${rec.my_price ? 'R'+Number(rec.my_price).toLocaleString('en-ZA',{minimumFractionDigits:2}) : '—'}</td>
            <td style="padding:8px;color:${rec.my_stock > 10 ? '#10b981' : rec.my_stock > 0 ? '#f59e0b' : '#ef4444'}">${rec.my_stock !== null && rec.my_stock !== undefined ? rec.my_stock : '—'}</td>
          </tr>`).join('')}
        </tbody>
      </table>
      ${d.records.length > 20 ? `<div style="font-size:0.8rem;color:#94a3b8;margin-top:6px;">...and ${d.records.length-20} more rows imported</div>` : ''}` : '';

    document.getElementById('importResult').innerHTML = skippedHtml + recordsHtml;

    // Reload dashboard to reflect new data
    allProducts = [];
    loadDashboard();
    fileInput.value = '';
  } catch(e) {
    showAlert('importAlert', `❌ Upload error: ${e.message}`, 'error');
  }
}

function downloadTemplate() {
  // Generate a CSV template matching the expected columns
  const csv = [
    'SKU,My Price,Stock,ASIN',
    '0011C013AA,1399,58,B08GQZDSB4',
    '0545C001AA,1660,9,B01ARH3Q5G',
    '0546C001AA,1660,8,B01ARGZTV6',
  ].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'buybox-import-template.csv'; a.click();
  URL.revokeObjectURL(url);
  return false;
}

// ── Bulk Upload ───────────────────────────────────────────────────
let _bulkPollTimer = null;

function _stopBulkPoll() {
  if (_bulkPollTimer) { clearInterval(_bulkPollTimer); _bulkPollTimer = null; }
}

function _parseBulkLines(raw) {
  // Extract ASINs from raw text (10-char alphanumeric, possibly in URLs)
  const asinRe = /\b([A-Z0-9]{10})\b/gi;
  const found = new Set();
  for (const m of raw.matchAll(asinRe)) found.add(m[1].toUpperCase());
  return [...found];
}

// ── Bulk Upload — Concurrent Pool via Chrome Extension ───────────
// Max CONCURRENT_TABS tabs open at once — when one closes (after scraping)
// the next one opens automatically. Handles 2200+ ASINs safely.
const CONCURRENT_TABS = 10;

async function submitBulk() {
  const raw = document.getElementById('bulkInput').value.trim();
  const market = document.getElementById('bulkMarket').value;
  if (!raw) { showAlert('bulkAlert','⚠️ Please enter at least one ASIN or URL','error'); return; }

  const asins = _parseBulkLines(raw);
  if (asins.length === 0) { showAlert('bulkAlert','⚠️ No valid ASINs found (10-character codes like B01ARH3Q5G)','error'); return; }

  const btn = document.getElementById('bulkBtn');
  btn.disabled = true;
  btn.innerHTML = `<span class="loading"></span>Running pool (${CONCURRENT_TABS} tabs)...`;
  showAlert('bulkAlert', `<span class="loading"></span>Starting concurrent pool — ${CONCURRENT_TABS} tabs open at a time for ${asins.length} ASINs...`, 'info');
  document.getElementById('bulkResult').innerHTML = '';
  _stopBulkPoll();

  const domain = market.replace('www.','');

  // ── Step 1: Snapshot CURRENT scraped_at from backend BEFORE opening any tabs ──
  // This ensures new ASINs (not yet in DB) don't get falsely detected as "done"
  // on the very first poll (they'd have a real scraped_at but no old snapshot).
  let baselineScrapedAts = {};
  try {
    const snap = await fetch(API + '/api/buybox/tracked');
    const snapData = await snap.json();
    (snapData.asins || []).forEach(p => { baselineScrapedAts[p.asin] = p.scraped_at; });
  } catch(e) {
    // If fetch fails, start with empty baseline — new ASINs will be detected correctly
    // once the backend confirms their first scraped_at after opening tabs
    baselineScrapedAts = {};
  }

  // ── Queue state ──
  let queueIdx = 0;         // next ASIN index to open
  let activeCount = 0;      // tabs currently open/pending
  let doneAsins = [];       // array of product objects (fully scraped)
  let failedAsins = [];     // array of {asin, error}
  let finished = false;
  const tabOpenedAt = {};   // asin → timestamp when tab was opened (for timeout)
  const TAB_TIMEOUT_MS = 60000; // 60s timeout per tab

  // ── Step 2: open next tab(s) — must be called synchronously from user gesture
  //    OR wrapped in setTimeout(0) for subsequent calls (avoids popup blocker)
  function openNextTab(useTimeout) {
    while (activeCount < CONCURRENT_TABS && queueIdx < asins.length) {
      const asin = asins[queueIdx++];
      activeCount++;
      tabOpenedAt[asin] = Date.now();
      const url = `https://www.${domain}/dp/${asin}?auto_scrape=1&dashboard=${encodeURIComponent(window.location.origin)}`;
      if (useTimeout) {
        // Slight stagger avoids browser popup blocker for calls outside user gesture
        const delay = (queueIdx % CONCURRENT_TABS) * 300;
        setTimeout(() => window.open(url, '_blank'), delay);
      } else {
        window.open(url, '_blank');
      }
    }
  }

  // ── Step 3: Kick off initial batch synchronously (inside button click = user gesture)
  openNextTab(false);

  // ── Step 4: Poll backend every 4s to detect completed scrapes ──
  // When scraped_at for an ASIN is NEW (different from baseline) → mark done → open next tab
  _bulkPollTimer = setInterval(async () => {
    if (finished) return;
    try {
      const r = await fetch(API + '/api/buybox/tracked');
      const d = await r.json();
      const products = d.asins || [];

      let newlyDone = false;
      products.forEach(p => {
        if (!asins.includes(p.asin)) return;
        if (doneAsins.find(x => x.asin === p.asin)) return;
        if (failedAsins.find(x => x.asin === p.asin)) return;
        const baseline = baselineScrapedAts[p.asin];
        // A scrape is "new" if scraped_at exists AND differs from our snapshot
        if (p.scraped_at && p.scraped_at !== baseline) {
          doneAsins.push(p);
          activeCount = Math.max(0, activeCount - 1);
          const idx = allProducts.findIndex(x => x.asin === p.asin);
          if (idx >= 0) allProducts[idx] = p; else allProducts.push(p);
          newlyDone = true;
          // Open the next queued tab to refill the pool
          if (queueIdx < asins.length) setTimeout(() => openNextTab(true), 0);
        }
      });

      // Check for timed-out tabs
      const now = Date.now();
      asins.forEach(asin => {
        if (doneAsins.find(x => x.asin === asin)) return;
        if (failedAsins.find(x => x.asin === asin)) return;
        const openedAt = tabOpenedAt[asin];
        if (openedAt && (now - openedAt) > TAB_TIMEOUT_MS) {
          failedAsins.push({asin, error: 'Timeout (60s)'});
          activeCount = Math.max(0, activeCount - 1);
          newlyDone = true;
          if (queueIdx < asins.length) setTimeout(() => openNextTab(true), 0);
        }
      });

      if (newlyDone || doneAsins.length > 0 || failedAsins.length > 0) {
        _renderBulkExtensionProgress(doneAsins.length + failedAsins.length, asins.length, doneAsins, failedAsins);
        updateStats(); renderTable();
      }

      // Check if all done
      if (doneAsins.length + failedAsins.length >= asins.length && !finished) {
        finished = true;
        _stopBulkPoll();
        btn.disabled = false; btn.innerHTML = '🚀 Fetch All via Extension';
        const winCount = allProducts.filter(p => asins.includes(p.asin) && p.buybox_status === 'winning').length;
        const loseCount = allProducts.filter(p => asins.includes(p.asin) && p.buybox_status === 'losing').length;
        const azCount = allProducts.filter(p => asins.includes(p.asin) && p.buybox_status === 'amazon').length;
        showAlert('bulkAlert', `✅ Done! ${doneAsins.length}/${asins.length} scraped — 🏆 ${winCount} winning · 😞 ${loseCount} losing · 🛒 ${azCount} Amazon`, 'success');
      }
    } catch(e) { console.error('Bulk poll error:', e); }
  }, 4000);
}

function _renderBulkExtensionProgress(opened, total, done, failed) {
  const pct = total > 0 ? Math.round((done.length / total) * 100) : Math.round((opened / total) * 100);
  const barColor = done.length === total ? '#10b981' : '#6366f1';
  const resultsHtml = done.length > 0 ? `
    <table style="width:100%;font-size:0.82rem;border-collapse:collapse;margin-top:12px;">
      <thead><tr style="background:#0f172a;">
        <th style="padding:8px;text-align:left;color:#94a3b8;">ASIN</th>
        <th style="padding:8px;text-align:left;color:#94a3b8;">Product</th>
        <th style="padding:8px;text-align:left;color:#94a3b8;">Price</th>
        <th style="padding:8px;text-align:left;color:#94a3b8;">Seller</th>
        <th style="padding:8px;text-align:left;color:#94a3b8;">Status</th>
      </tr></thead>
      <tbody>${done.map(p=>`
        <tr style="border-bottom:1px solid #1e293b;">
          <td style="padding:8px;font-family:monospace;color:#94a3b8;">${p.asin}</td>
          <td style="padding:8px;max-width:200px;">${(p.title||'—').substring(0,60)}</td>
          <td style="padding:8px;">${fmtPrice(p.buybox_price,p.marketplace)}</td>
          <td style="padding:8px;">${fmtSeller(p.buybox_seller,p.buybox_status)}</td>
          <td style="padding:8px;">${fmtStatus(p.buybox_status)}</td>
        </tr>`).join('')}
      </tbody>
    </table>` : '';

  document.getElementById('bulkResult').innerHTML = `
    <div style="margin-top:14px;">
      <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:#94a3b8;margin-bottom:6px;">
        <span>${done.length === total ? '✅ Complete' : `⏳ Scraped ${done.length}/${total} ASINs via extension...`}
          ${failed.length > 0 ? `<span style="color:#ef4444;margin-left:8px;">· ${failed.length} timed out</span>` : ''}
        </span>
        <span style="color:${done.length===total?'#10b981':'#f59e0b'};font-weight:700;">${pct}%</span>
      </div>
      <div style="height:8px;background:#0f172a;border-radius:4px;overflow:hidden;">
        <div style="height:100%;width:${pct}%;background:${barColor};border-radius:4px;transition:width 0.5s ease;"></div>
      </div>
      ${resultsHtml}
    </div>`;
}


// ── Excel Import ──────────────────────────────────────────────────
async function importExcel() {
  const fileInput = document.getElementById('excelFile');
  const file = fileInput.files[0];
  if (!file) { showAlert('importAlert', '⚠️ Please select an Excel or CSV file first', 'error'); return; }

  const formData = new FormData();
  formData.append('file', file);

  showAlert('importAlert', `<span class="loading"></span>Importing <b>${file.name}</b>...`, 'info');
  document.getElementById('importResult').innerHTML = '';

  try {
    const r = await fetch(API + '/api/import/excel', { method: 'POST', body: formData });
    const d = await r.json();

    if (!r.ok) throw new Error(d.detail || `HTTP ${r.status}`);

    showAlert('importAlert', `✅ ${d.message} — ${d.skipped} rows skipped`, 'success');

    // Show results table
    if (d.records && d.records.length > 0) {
      document.getElementById('importResult').innerHTML = `
        <div style="margin-top:12px;">
          <table style="width:100%;font-size:0.82rem;border-collapse:collapse;">
            <thead><tr style="background:#0f172a;">
              <th style="padding:8px;text-align:left;color:#94a3b8;">ASIN</th>
              <th style="padding:8px;text-align:left;color:#94a3b8;">SKU</th>
              <th style="padding:8px;text-align:left;color:#94a3b8;">My Price</th>
              <th style="padding:8px;text-align:left;color:#94a3b8;">Stock</th>
            </tr></thead>
            <tbody>${d.records.map(r => `
              <tr style="border-bottom:1px solid #1e293b;">
                <td style="padding:8px;font-family:monospace;color:#94a3b8;">${r.asin}</td>
                <td style="padding:8px;color:#e2e8f0;">${r.sku || '—'}</td>
                <td style="padding:8px;color:#34d399;">${r.my_price ? 'R' + Number(r.my_price).toLocaleString('en-ZA', {minimumFractionDigits:2}) : '—'}</td>
                <td style="padding:8px;color:${r.my_stock > 10 ? '#10b981' : r.my_stock > 0 ? '#f59e0b' : '#ef4444'};">${r.my_stock !== null && r.my_stock !== undefined ? r.my_stock : '—'}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
    }

    // Reload dashboard to show updated data
    await loadDashboard();
    fileInput.value = '';
  } catch(e) {
    showAlert('importAlert', `❌ Import failed: ${e.message}`, 'error');
  }
}

function downloadTemplate() {
  // Generate a CSV template for download
  const csv = 'ASIN,SKU,My Price,Stock\nB01ARGZ8N0,SKU-CANON-001,1599.00,25\nB09V1WCCY2,SKU-HP-002,4999.00,10\n';
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'buybox-import-template.csv';
  a.click(); URL.revokeObjectURL(url);
  return false;
}

// ── Analytics ─────────────────────────────────────────────────────
function loadAnalytics() {
  const data = allProducts;
  if (!data.length) return;

  const winning = data.filter(p=>p.buybox_status==='winning').length;
  const losing  = data.filter(p=>p.buybox_status==='losing').length;
  const amazon  = data.filter(p=>p.buybox_status==='amazon').length;
  const total   = data.length;

  // Pie chart
  document.getElementById('pieChart').innerHTML = `
    <div class="pie-item"><div class="pie-circle" style="background:rgba(16,185,129,0.2);color:#10b981;">${winning}</div><div style="font-size:0.8rem;">🏆 Winning</div></div>
    <div class="pie-item"><div class="pie-circle" style="background:rgba(239,68,68,0.2);color:#ef4444;">${losing}</div><div style="font-size:0.8rem;">😞 Losing</div></div>
    <div class="pie-item"><div class="pie-circle" style="background:rgba(59,130,246,0.2);color:#3b82f6;">${amazon}</div><div style="font-size:0.8rem;">🛒 Amazon</div></div>
    <div class="pie-item"><div class="pie-circle" style="background:rgba(249,115,22,0.2);color:#f97316;">${total}</div><div style="font-size:0.8rem;">📦 Total</div></div>`;

  // Top prices bar chart
  const topPrices = [...data].filter(p=>p.buybox_price).sort((a,b)=>b.buybox_price-a.buybox_price).slice(0,8);
  const maxPrice = topPrices[0]?.buybox_price || 1;
  document.getElementById('topPricesChart').innerHTML = topPrices.map(p=>`
    <div class="bar-row">
      <div class="bar-label" title="${p.title}">${p.asin}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(p.buybox_price/maxPrice*100).toFixed(0)}%;background:#a78bfa;">R${Number(p.buybox_price).toLocaleString('en-ZA',{minimumFractionDigits:2})}</div></div>
    </div>`).join('') || '<p style="color:#475569;font-size:0.85rem;">No price data</p>';

  // Sellers bar chart
  const sellerCount = {};
  data.forEach(p => { if (p.buybox_seller) sellerCount[p.buybox_seller] = (sellerCount[p.buybox_seller]||0)+1; });
  const sellers = Object.entries(sellerCount).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const maxSeller = sellers[0]?.[1] || 1;
  document.getElementById('sellersChart').innerHTML = sellers.map(([name,count])=>{
    const isMe = name.toLowerCase().includes('bonolo');
    const isAm = name.toLowerCase().includes('amazon');
    const color = isMe?'#10b981':isAm?'#3b82f6':'#f97316';
    return `<div class="bar-row">
      <div class="bar-label" title="${name}">${name}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(count/maxSeller*100).toFixed(0)}%;background:${color};">${count}</div></div>
    </div>`;
  }).join('') || '<p style="color:#475569;font-size:0.85rem;">No seller data</p>';

  // Win rate
  const winRate = total ? ((winning/total)*100).toFixed(1) : 0;
  document.getElementById('winRatePanel').innerHTML = `
    <div style="text-align:center;padding:16px;">
      <div style="font-size:3rem;font-weight:800;color:${winRate>=50?'#10b981':'#ef4444'};">${winRate}%</div>
      <div style="color:#94a3b8;font-size:0.85rem;margin:8px 0;">Buybox Win Rate</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${winRate}%;background:${winRate>=50?'#10b981':'#ef4444'};"></div></div>
      <div style="margin-top:16px;font-size:0.85rem;color:#94a3b8;">
        ${winning} of ${total} products have buybox
      </div>
    </div>`;

  // Analytics snapshot table
  document.getElementById('analyticsBody').innerHTML = data.map((p,i)=>`
    <tr>
      <td style="color:#475569;font-size:0.8rem;">${i+1}</td>
      <td style="max-width:240px;font-size:0.82rem;">${p.title||'—'}</td>
      <td><span class="asin-code">${p.asin}</span></td>
      <td>${fmtPrice(p.buybox_price,p.marketplace)}</td>
      <td>${fmtSeller(p.buybox_seller,p.buybox_status)}</td>
      <td>${fmtStatus(p.buybox_status)}</td>
      <td style="color:#fbbf24;">${p.rating?'⭐ '+p.rating:'—'}</td>
      <td style="font-size:0.78rem;color:#94a3b8;">${fmtTime(p.scraped_at)}</td>
    </tr>`).join('');
}

// ── Settings Page ─────────────────────────────────────────────────
async function loadSettings() {
  try {
    const r = await fetch(API + '/api/alerts/settings');
    const d = await r.json();
    if (d.whatsapp_phone) document.getElementById('waPhone').value = d.whatsapp_phone;
    if (d.callmebot_apikey) document.getElementById('waApiKey').value = d.callmebot_apikey;
    if (d.telegram_bot_token) document.getElementById('tgBotToken').value = d.telegram_bot_token;
    if (d.telegram_chat_id) document.getElementById('tgChatId').value = d.telegram_chat_id;
    if (d.alert_losing !== undefined) document.getElementById('alertLosing').checked = d.alert_losing;
    if (d.alert_winning !== undefined) document.getElementById('alertWinning').checked = d.alert_winning;
    if (d.alert_amazon !== undefined) document.getElementById('alertAmazon').checked = d.alert_amazon;
  } catch(e) {}
  loadSchedulerStatus();
}

async function loadSchedulerStatus() {
  try {
    const r = await fetch(API + '/api/scheduler/status');
    const d = await r.json();
    const el = document.getElementById('schedulerStatus');
    const nextRun = d.next_run ? new Date(d.next_run).toLocaleString() : 'Not scheduled';
    const lastRun = d.last_run ? new Date(d.last_run).toLocaleString() : 'Never';
    el.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
        <div><span style="color:#94a3b8;">Status:</span> <b style="color:${d.enabled ? '#10b981' : '#ef4444'}">${d.enabled ? '✅ Running' : '⏸ Paused'}</b></div>
        <div><span style="color:#94a3b8;">Interval:</span> <b style="color:#f97316;">Every ${d.interval_hours || 6} hours</b></div>
        <div><span style="color:#94a3b8;">Last Run:</span> <b>${lastRun}</b></div>
        <div><span style="color:#94a3b8;">Next Run:</span> <b style="color:#3b82f6;">${nextRun}</b></div>
        <div><span style="color:#94a3b8;">ASINs tracked:</span> <b>${d.total_asins || 0}</b></div>
      </div>`;
    if (d.interval_hours) {
      const sel = document.getElementById('refreshInterval');
      for (let o of sel.options) { if (parseFloat(o.value) === d.interval_hours) { o.selected = true; break; } }
    }
    document.getElementById('schedulerEnabled').value = d.enabled ? 'true' : 'false';
  } catch(e) {
    document.getElementById('schedulerStatus').innerHTML = '<span style="color:#ef4444;">Could not load scheduler status</span>';
  }
}

async function saveAlertSettings() {
  const settings = {
    whatsapp_phone: document.getElementById('waPhone').value.trim(),
    callmebot_apikey: document.getElementById('waApiKey').value.trim(),
    telegram_bot_token: document.getElementById('tgBotToken').value.trim(),
    telegram_chat_id: document.getElementById('tgChatId').value.trim(),
    alert_losing: document.getElementById('alertLosing').checked,
    alert_winning: document.getElementById('alertWinning').checked,
    alert_amazon: document.getElementById('alertAmazon').checked,
  };
  try {
    const r = await fetch(API + '/api/alerts/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(settings) });
    const d = await r.json();
    showAlert('alertSettingsMsg', '✅ Alert settings saved successfully!', 'success');
    showAlert('telegramSettingsMsg', '✅ Settings saved!', 'success');
  } catch(e) {
    showAlert('alertSettingsMsg', '❌ Failed to save settings', 'error');
    showAlert('telegramSettingsMsg', '❌ Failed to save settings', 'error');
  }
}

async function fetchTelegramChatId() {
  const token = document.getElementById('tgBotToken').value.trim();
  if (!token) {
    document.getElementById('tgChatIdMsg').innerHTML = '<span style="color:#ef4444;">⚠️ Please paste your Bot Token first</span>';
    return;
  }
  document.getElementById('tgChatIdMsg').innerHTML = '<span style="color:#93c5fd;">🔍 Detecting your Chat ID...</span>';
  try {
    const r = await fetch(`https://api.telegram.org/bot${token}/getUpdates`);
    const d = await r.json();
    if (!d.ok) {
      document.getElementById('tgChatIdMsg').innerHTML = '<span style="color:#ef4444;">❌ Invalid Bot Token. Double-check it from @BotFather.</span>';
      return;
    }
    if (!d.result || d.result.length === 0) {
      document.getElementById('tgChatIdMsg').innerHTML = '<span style="color:#f97316;">⚠️ No messages found. Open Telegram, find your bot, and send it <b>/start</b> — then click Auto-Detect again.</span>';
      return;
    }
    const msg = d.result[d.result.length - 1];
    const chatId = msg.message?.chat?.id || msg.channel_post?.chat?.id;
    const chatName = msg.message?.chat?.first_name || msg.message?.chat?.title || msg.channel_post?.chat?.title || 'your chat';
    if (chatId) {
      document.getElementById('tgChatId').value = chatId;
      document.getElementById('tgChatIdMsg').innerHTML = `<span style="color:#10b981;">✅ Chat ID detected: <b>${chatId}</b> (${chatName}). Click Save Settings to keep it.</span>`;
    } else {
      document.getElementById('tgChatIdMsg').innerHTML = '<span style="color:#ef4444;">❌ Could not read Chat ID. Try sending /start to your bot again.</span>';
    }
  } catch(e) {
    document.getElementById('tgChatIdMsg').innerHTML = '<span style="color:#ef4444;">❌ Error: ' + e.message + '</span>';
  }
}

async function testTelegram() {
  showAlert('telegramSettingsMsg', '📤 Sending test Telegram message...', 'info');
  // Save current values first so the backend has them
  await saveAlertSettings();
  try {
    const r = await fetch(API + '/api/alerts/test-telegram', { method:'POST' });
    const d = await r.json();
    showAlert('telegramSettingsMsg', d.success ? '✅ Test Telegram message sent! Check your chat.' : '❌ Failed: ' + (d.detail || d.message || 'Unknown error'), d.success ? 'success' : 'error');
  } catch(e) {
    showAlert('telegramSettingsMsg', '❌ Error: ' + e.message, 'error');
  }
}

async function testWhatsApp() {
  showAlert('alertSettingsMsg', '📤 Sending test message...', 'info');
  // Save current values first so the backend has them
  await saveAlertSettings();
  try {
    const r = await fetch(API + '/api/alerts/test', { method:'POST' });
    const d = await r.json();
    showAlert('alertSettingsMsg', d.success ? '✅ Test WhatsApp message sent! Check your phone.' : '❌ Failed: ' + (d.message || 'Unknown error'), d.success ? 'success' : 'error');
  } catch(e) {
    showAlert('alertSettingsMsg', '❌ Error sending test message. Check your phone number and API key.', 'error');
  }
}

async function saveSchedulerSettings() {
  const settings = {
    interval_hours: parseFloat(document.getElementById('refreshInterval').value),
    enabled: document.getElementById('schedulerEnabled').value === 'true',
  };
  try {
    const r = await fetch(API + '/api/scheduler/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(settings) });
    const d = await r.json();
    showAlert('schedulerMsg', '✅ ' + d.message, 'success');
    loadSchedulerStatus();
  } catch(e) {
    showAlert('schedulerMsg', '❌ Failed to save scheduler settings', 'error');
  }
}

async function runNow() {
  showAlert('schedulerMsg', '⚡ Triggering refresh of all tracked ASINs...', 'info');
  try {
    const r = await fetch(API + '/api/scheduler/run-now', { method:'POST' });
    const d = await r.json();
    showAlert('schedulerMsg', '✅ ' + d.message, 'success');
    setTimeout(() => { loadDashboard(); loadSchedulerStatus(); }, 3000);
  } catch(e) {
    showAlert('schedulerMsg', '❌ Failed to trigger refresh', 'error');
  }
}

// ── Init ──────────────────────────────────────────────────────────
checkHealth();
setInterval(checkHealth, 30000);
loadDashboard();
</script>
</html>
